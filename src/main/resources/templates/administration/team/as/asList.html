<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko" data-layout="twocolumn" data-sidebar="light" data-sidebar-size="lg"
	data-sidebar-image="none" data-preloader="disable">

<head th:replace="~{fragments/administration/common :: autoAdminHead}"></head>

<body class="twocolumn-panel">
	<div id="layout-wrapper">
		<header th:replace="~{fragments/administration/common :: autoAdminHeader}"></header>
		<div th:replace="~{fragments/administration/common :: autoAdminModal}"></div>
		<div th:replace="~{fragments/administration/common :: autoAdminSideMenu}"></div>
		<div class="vertical-overlay"></div>

		<div class="main-content">
			<div class="page-content">
				<div class="container-fluid">

					<div class="row">
						<div class="col-12">
							<div class="page-title-box d-sm-flex align-items-center justify-content-between">
								<h4 class="mb-sm-0">AS팀업무현황</h4>
								<div class="page-title-right">
									<ol class="breadcrumb m-0">
										<li class="breadcrumb-item"><a href="#">팀별업무관리</a></li>
										<li class="breadcrumb-item active">AS팀</li>
									</ol>
								</div>
							</div>
						</div>
					</div>

					<!-- ✅ 검색 폼 -->
					<form method="get" th:action="@{/team/asList}" class="row">
						<div class="col-lg-12">
							<div class="row g-4 mb-3">

								<!-- 상태 -->
								<div class="col-lg-1">
									<label class="form-label">상태</label>
									<select name="status" class="form-select">
										<option value="" th:selected="${selectedStatus == null}">전체</option>
										<option value="REQUESTED"
											th:selected="${selectedStatus?.name() == 'REQUESTED'}">요청됨</option>
										<option value="IN_PROGRESS"
											th:selected="${selectedStatus?.name() == 'IN_PROGRESS'}">진행중</option>
										<option value="COMPLETED"
											th:selected="${selectedStatus?.name() == 'COMPLETED'}">완료</option>
										<option value="CANCELED" th:selected="${selectedStatus?.name() == 'CANCELED'}">
											취소</option>
									</select>
								</div>

								<!-- 조회조건 -->
								<div class="col-lg-1">
									<label class="form-label">조회조건</label>
									<select name="dateType" class="form-select">
										<option value="requested"
											th:selected="${dateType == null || dateType == 'requested'}">신청일</option>
										<option value="processed" th:selected="${dateType == 'processed'}">처리일</option>
									</select>
								</div>

								<!-- 시작일 -->
								<div class="col-lg-2">
									<label class="form-label">시작일</label>
									<input type="date" name="startDate"
										th:value="${startDate != null ? #temporals.format(startDate, 'yyyy-MM-dd') : ''}"
										class="form-control">
								</div>

								<!-- 종료일 -->
								<div class="col-lg-2">
									<label class="form-label">종료일</label>
									<input type="date" name="endDate"
										th:value="${endDate != null ? #temporals.format(endDate, 'yyyy-MM-dd') : ''}"
										class="form-control">
								</div>

								<!-- ✅ 업체명 검색 -->
								<div class="col-lg-2">
									<label class="form-label">업체명</label>
									<input type="text" name="companyKeyword" class="form-control" placeholder="업체명 검색"
										th:value="${companyKeyword}">
								</div>

								<!-- ✅ Province -->
								<div class="col-lg-1">
									<label class="form-label">도/광역시</label>
									<select name="provinceId" id="as-province-select" class="form-select">
										<option value="">전체</option>
										<option th:each="p : ${provinces}" th:value="${p.id}" th:text="${p.name}"
											th:selected="${provinceId != null && provinceId == p.id}">
										</option>
									</select>
								</div>

								<!-- ✅ City/District(직접) : label도 같이 토글 -->
								<div class="col-lg-1" id="as-child-wrapper" style="display:none;">
									<label class="form-label" id="as-child-label">시/군</label>

									<select name="cityId" id="as-city-select" class="form-select" style="display:none;">
										<option value="">전체</option>
									</select>

									<!-- ⚠️ name 제거(중복 전송 방지). 실제 전송은 hidden districtId로만 -->
									<select id="as-district-direct-select" class="form-select" style="display:none;">
										<option value="">전체</option>
									</select>
								</div>

								<!-- ✅ District (City 선택 후) : label도 같이 토글 -->
								<div class="col-lg-1" id="as-district-wrapper" style="display:none;">
									<label class="form-label">구/읍/면</label>

									<!-- ⚠️ name 제거(중복 전송 방지). 실제 전송은 hidden districtId로만 -->
									<select id="as-district-select" class="form-select" style="display:none;">
										<option value="">전체</option>
									</select>
								</div>

								<!-- 검색 버튼 -->
								<div class="col-lg-1">
									<label class="form-label">조회</label>
									<button type="submit" class="btn btn-primary w-100">검색하기</button>
								</div>

								<!-- ✅ districtId는 hidden input 하나로만 전송 -->
								<input type="hidden" name="districtId" id="as-district-hidden"
									th:value="${districtId != null ? districtId : ''}" />

							</div>
						</div>
					</form>

					<!-- ✅ 테이블 리스트(카드형 → 테이블형) -->
					<div class="row">
						<div class="col-lg-12">

							<!-- 데이터 있을 때 -->
							<div class="as-list-added-table-card card" th:if="${asPage.totalElements > 0}">
								<div class="card-body as-list-added-table-card-body">

									<div class="as-list-added-table-responsive table-responsive">
										<table class="table as-list-added-table align-middle mb-0">
											<thead class="as-list-added-thead">
												<tr>
													<th class="as-list-added-th as-list-added-col-id">ID</th>
													<th class="as-list-added-th as-list-added-col-status">상태</th>
													<th class="as-list-added-th as-list-added-col-requester">신청자</th>
													<th class="as-list-added-th as-list-added-col-address">주소</th>
													<th class="as-list-added-th as-list-added-col-memo">메모</th>
													<th class="as-list-added-th as-list-added-col-requestedAt">신청일</th>
													<th class="as-list-added-th as-list-added-col-processedAt">처리일</th>
													<th class="as-list-added-th as-list-added-col-actions">비고</th>
												</tr>
											</thead>

											<tbody class="as-list-added-tbody">
												<tr th:each="task : ${asPage.content}" class="as-list-added-tr">

													<!-- ID -->
													<td class="as-list-added-td as-list-added-col-id">
														<span class="as-list-added-id" th:text="${task.id}">1</span>
													</td>

													<!-- 상태 -->
													<td class="as-list-added-td as-list-added-col-status">
														<span class="badge as-list-added-status-badge" th:classappend="${
                                                          task.status?.name() == 'REQUESTED' ? ' as-list-added-badge-requested' :
                                                          task.status?.name() == 'IN_PROGRESS' ? ' as-list-added-badge-progress' :
                                                          task.status?.name() == 'COMPLETED' ? ' as-list-added-badge-completed' :
                                                          task.status?.name() == 'CANCELED' ? ' as-list-added-badge-canceled' : ''
                                                      }" th:text="${
                                                          task.status?.name() == 'REQUESTED' ? '요청됨' :
                                                          task.status?.name() == 'IN_PROGRESS' ? '진행중' :
                                                          task.status?.name() == 'COMPLETED' ? '완료' :
                                                          task.status?.name() == 'CANCELED' ? '취소' : task.status
                                                      }">요청됨</span>
													</td>

													<!-- 신청자 -->
													<td class="as-list-added-td as-list-added-col-requester">
														<span class="as-list-added-requester"
															th:text="${task.requestedBy.name}">홍길동</span>
													</td>

													<!-- 주소 -->
													<td class="as-list-added-td as-list-added-col-address">
														<div class="as-list-added-address"
															th:text="${task.roadAddress + ' ' + task.detailAddress}">
															주소
														</div>
													</td>

													<!-- 메모(기존 비고) -->
													<td class="as-list-added-td as-list-added-col-memo">
														<div class="as-list-added-memo" th:text="${task.asComment}">비고
														</div>
													</td>

													<!-- 신청일 -->
													<td class="as-list-added-td as-list-added-col-requestedAt">
														<span class="as-list-added-date"
															th:text="${#temporals.format(task.requestedAt, 'yyyy-MM-dd')}">2026-01-01</span>
													</td>

													<!-- 처리일 -->
													<td class="as-list-added-td as-list-added-col-processedAt">
														<span class="as-list-added-date"
															th:text="${task.asProcessDate != null ? #temporals.format(task.asProcessDate, 'yyyy-MM-dd') : '-'}">-</span>
													</td>

													<!-- 비고(버튼 2개: 상세보기/완료처리) -->
													<td class="as-list-added-td as-list-added-col-actions">
														<div class="as-list-added-actions">
															<a class="btn btn-sm btn-outline-primary as-list-added-btn-detail"
																th:href="@{'/team/asDetail/' + ${task.id}}">
																상세보기
															</a>

															<!-- 완료처리: 기존 로직/JS에 맞춰 연결하실 수 있도록 data-task-id 제공 -->
															<a class="btn btn-sm btn-success as-list-added-btn-complete"
																href="#" th:attr="data-task-id=${task.id}">
																완료처리
															</a>
														</div>
													</td>

												</tr>
											</tbody>
										</table>
									</div>

								</div>
							</div>

							<!-- 데이터 없을 때 -->
							<div th:if="${asPage.totalElements == 0}" class="text-center mt-5 as-list-added-empty">
								<p class="text-muted mb-0">조회된 AS 업무가 없습니다.</p>
							</div>

						</div>
					</div>

					<!-- ✅ 페이지네이션: 신규 파라미터까지 전부 유지 -->
					<div class="row g-0 justify-content-center mt-4 production-pagination">
						<div class="col-auto">
							<ul class="pagination pagination-separated">

								<li th:classappend="${asPage.first} ? 'disabled'" class="page-item">
									<a class="page-link" th:href="@{|/team/asList?page=0
                                    &dateType=${dateType}
                                    &startDate=${startDate != null ? #temporals.format(startDate, 'yyyy-MM-dd') : ''}
                                    &endDate=${endDate != null ? #temporals.format(endDate, 'yyyy-MM-dd') : ''}
                                    &status=${selectedStatus}
                                    &companyKeyword=${companyKeyword}
                                    &provinceId=${provinceId}
                                    &cityId=${cityId}
                                    &districtId=${districtId}
                                |}">FIRST</a>
								</li>

								<li th:classappend="${asPage.first} ? 'disabled'" class="page-item">
									<a class="page-link" th:href="@{|/team/asList?page=${asPage.number - 1}
                                    &dateType=${dateType}
                                    &startDate=${startDate != null ? #temporals.format(startDate, 'yyyy-MM-dd') : ''}
                                    &endDate=${endDate != null ? #temporals.format(endDate, 'yyyy-MM-dd') : ''}
                                    &status=${selectedStatus}
                                    &companyKeyword=${companyKeyword}
                                    &provinceId=${provinceId}
                                    &cityId=${cityId}
                                    &districtId=${districtId}
                                |}">PREV</a>
								</li>

								<li th:each="i : ${#numbers.sequence(0, asPage.totalPages - 1)}"
									th:classappend="${asPage.number == i} ? 'active'" class="page-item">
									<a class="page-link" th:text="${i + 1}" th:href="@{|/team/asList?page=${i}
                                    &dateType=${dateType}
                                    &startDate=${startDate != null ? #temporals.format(startDate, 'yyyy-MM-dd') : ''}
                                    &endDate=${endDate != null ? #temporals.format(endDate, 'yyyy-MM-dd') : ''}
                                    &status=${selectedStatus}
                                    &companyKeyword=${companyKeyword}
                                    &provinceId=${provinceId}
                                    &cityId=${cityId}
                                    &districtId=${districtId}
                                |}">1</a>
								</li>

								<li th:classappend="${asPage.last} ? 'disabled'" class="page-item">
									<a class="page-link" th:href="@{|/team/asList?page=${asPage.number + 1}
                                    &dateType=${dateType}
                                    &startDate=${startDate != null ? #temporals.format(startDate, 'yyyy-MM-dd') : ''}
                                    &endDate=${endDate != null ? #temporals.format(endDate, 'yyyy-MM-dd') : ''}
                                    &status=${selectedStatus}
                                    &companyKeyword=${companyKeyword}
                                    &provinceId=${provinceId}
                                    &cityId=${cityId}
                                    &districtId=${districtId}
                                |}">NEXT</a>
								</li>

								<li th:classappend="${asPage.last} ? 'disabled'" class="page-item">
									<a class="page-link" th:href="@{|/team/asList?page=${asPage.totalPages - 1}
                                    &dateType=${dateType}
                                    &startDate=${startDate != null ? #temporals.format(startDate, 'yyyy-MM-dd') : ''}
                                    &endDate=${endDate != null ? #temporals.format(endDate, 'yyyy-MM-dd') : ''}
                                    &status=${selectedStatus}
                                    &companyKeyword=${companyKeyword}
                                    &provinceId=${provinceId}
                                    &cityId=${cityId}
                                    &districtId=${districtId}
                                |}">LAST</a>
								</li>

							</ul>
						</div>
					</div>

				</div>
			</div>

			<footer th:replace="~{fragments/administration/common :: autoAdminFooter}"></footer>
		</div>
	</div>

	<th:block th:replace="~{fragments/administration/common :: autoAdminSetting}"></th:block>
	<th:block th:replace="~{fragments/administration/common :: authAdminScript}"></th:block>

	<!-- ✅ JS: 행정구역 동적 셀렉트 -->
	<script th:inline="javascript">
		window.__AS_SELECTED__ = {
			provinceId: /*[[${provinceId}]]*/ null,
			cityId: /*[[${cityId}]]*/ null,
			districtId: /*[[${districtId}]]*/ null
		};
	</script>
	<script src="/administration/assets/js/page/asList.js"></script>

</body>

</html>