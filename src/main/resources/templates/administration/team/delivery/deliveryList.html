<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko" data-layout="twocolumn" data-sidebar="light" data-sidebar-size="lg"
	data-sidebar-image="none" data-preloader="disable">

<head th:replace="~{fragments/administration/common :: autoAdminHead}"></head>

<body class="twocolumn-panel">
	<div id="layout-wrapper">
		<header th:replace="~{fragments/administration/common :: autoAdminHeader}"></header>
		<div th:replace="~{fragments/administration/common :: autoAdminModal}"></div>
		<div th:replace="~{fragments/administration/common :: autoAdminSideMenu}"></div>
		<div class="vertical-overlay"></div>

		<div class="main-content">
			<div class="page-content">
				<div class="container-fluid">

					<div class="row">
						<div class="col-12">
							<div class="page-title-box d-sm-flex align-items-center justify-content-between">
								<h4 class="mb-sm-0">배송리스트</h4>
								<div class="page-title-right">
									<ol class="breadcrumb m-0">
										<li class="breadcrumb-item"><a href="javascript: void(0);">팀별업무관리</a></li>
										<li class="breadcrumb-item"><a href="javascript: void(0);">배송팀</a></li>
										<li class="breadcrumb-item active">배송리스트</li>
									</ol>
								</div>
							</div>
						</div>
					</div>

					<!-- ✅ 필터 폼 -->
					<form method="get" th:action="@{/team/deliveryList}" class="row">
						<div class="col-lg-10">
							<div class="row g-4 mb-3">

								<div class="col-lg-4 col-md-5 col-sm-5 col-xs-5">
									<label class="form-label">출고일 조회</label>
									<input type="text" name="preferredDate" id="deliveryDate" class="form-control"
										placeholder="YYYY-MM-DD" data-provider="flatpickr" th:value="${preferredDate}">
								</div>

								<div class="col-lg-4 col-md-5 col-sm-5 col-xs-5">
									<label class="form-label">상태</label>
									<select class="form-select" name="status">
										<option value="" th:selected="${status == null}">전체(승인/생산완료/배송완료)</option>
										<option th:each="st : ${availableStatuses}" th:value="${st}" th:text="${st.label}"
											th:selected="${status != null and status.name() == st.name()}">
										</option>
									</select>
								</div>

								<div class="col-lg-2 col-md-2 col-sm-2 col-xs-2">
									<label class="form-label">조회</label>
									<button type="submit" class="btn btn-primary w-100">검색하기</button>
								</div>

							</div>
						</div>
					</form>

					<div class="row">
						<div class="col-lg-12">
							<div class="card">
								<div class="card-header d-flex align-items-center justify-content-between">
									<div class="d-flex align-items-center gap-2 flex-wrap">
										<button type="button" class="btn btn-success" id="saveOrderIndexBtn" disabled>
											순서 저장
										</button>

										<button type="button" class="btn btn-outline-primary" id="reorderByTaskBtn">
											업체별정렬
										</button>

										<button type="button" class="btn btn-outline-dark" id="delivery-list-added-excelBtn">
											엑셀출력
										</button>

										<small class="text-muted">
											※ 미완료(승인/생산완료)만 순서 변경 가능하며, 배송완료는 하단 고정입니다.
											<br />
											※ 모바일은 <b>핸들(≡)</b>로만 순서 변경됩니다.
										</small>
									</div>

									<div class="m-d-n">
										<span class="badge bg-warning-subtle text-warning me-1">미완료</span>
										<span class="badge bg-success-subtle text-success">배송완료</span>
									</div>
								</div>

								<div class="card-body">

									<!-- ✅ 미완료 섹션 -->
									<div class="mb-3">
										<h5 class="mb-2">미완료</h5>

										<div id="pendingList" class="list-group col nested-list nested-sortable">
											<div class="list-group-item nested-1 draggable-item delivery-card delivery-list-added-card delivery-list-added-card-clickable"
												th:each="wrap : ${pendingOrders}" th:with="o=${wrap.order}" th:attr="
													data-order-id=${o.id},
													data-task-id=${o.task != null ? o.task.id : 0},
													data-order-status=${o.status.name()}
												"
												th:classappend="${o.status.name() == 'PRODUCTION_DONE'} ? ' border border-warning' : ' border border-secondary'">

												<div class="item-content delivery-list-added-item-content">

													<!-- ✅ 드래그 핸들(모든 디바이스에서 핸들로만 드래그) -->
													<button type="button" class="delivery-list-added-drag-handle" aria-label="순서 변경(드래그)">
														≡
													</button>

													<div class="text-section">
														<div class="d-flex align-items-center gap-2 mb-1 flex-wrap">
															<strong>업체명:</strong>
															<span th:text="${o.task.requestedBy.company.companyName}"></span>

															<span class="badge"
																th:classappend="${o.status.name() == 'CONFIRMED'} ? ' bg-secondary' :
																			   (${o.status.name() == 'PRODUCTION_DONE'} ? ' bg-warning' : ' bg-light')"
																th:text="${o.status.label}">
															</span>

															<small class="text-muted" th:if="${o.status.name() == 'CONFIRMED'}">
																(승인: 상세확인만 가능 / 순서변경 가능)
															</small>
															<small class="text-muted" th:if="${o.status.name() == 'PRODUCTION_DONE'}">
																(생산완료: 배송완료 처리 가능 / 순서변경 가능)
															</small>
														</div>

														<div class="delivery-list-added-line">
															<strong>주소:</strong>
															<span th:text="${o.roadAddress + ' ' + o.detailAddress}"></span>
														</div>

														<div class="ellipsis delivery-list-added-line">
															<strong>제품 상세:</strong>
															<span th:text="${#strings.isEmpty(o.orderItem.formattedOptionText)
															    ? o.orderItem.productName
															    : o.orderItem.formattedOptionText}">
															</span>
														</div>
													</div>

													<!-- ✅ 액션: 상태에 따라 버튼 1개만 -->
													<div class="action-btn-group delivery-list-added-action">
														<!-- 생산완료 => 배송완료(complete 모드) -->
														<button type="button"
															class="action-btn btn-complete delivery-list-added-open-complete-modal"
															th:if="${o.status.name() == 'PRODUCTION_DONE'}"
															th:attr="data-order-id=${o.id}">
															배송완료
														</button>

														<!-- 그 외 => 배송상세(detail 모드) -->
														<button type="button"
															class="action-btn delivery-list-added-open-detail-modal"
															th:if="${o.status.name() != 'PRODUCTION_DONE'}"
															th:attr="data-order-id=${o.id}">
															배송상세
														</button>
													</div>

												</div>
											</div>
										</div>
									</div>

									<!-- ✅ 배송완료 섹션 -->
									<div class="mt-4">
										<h5 class="mb-2">배송완료</h5>

										<div id="doneList" class="list-group col nested-list">
											<div class="list-group-item nested-1 draggable-item delivery-card is-done border border-success delivery-list-added-card delivery-list-added-card-clickable"
												th:each="wrap : ${doneOrders}" th:with="o=${wrap.order}" th:attr="
													data-order-id=${o.id},
													data-task-id=${o.task != null ? o.task.id : 0},
													data-order-status=${o.status.name()}
												">

												<div class="item-content delivery-list-added-item-content">

													<!-- ✅ 배송완료는 순서 변경 불가 (핸들은 비활성 느낌) -->
													<button type="button"
														class="delivery-list-added-drag-handle delivery-list-added-drag-handle-disabled"
														aria-label="순서 변경 불가" tabindex="-1">
														≡
													</button>

													<div class="text-section">
														<div class="d-flex align-items-center gap-2 mb-1 flex-wrap">
															<strong>업체명:</strong>
															<span th:text="${o.task.requestedBy.company.companyName}"></span>

															<span class="badge bg-success" th:text="${o.status.label}"></span>

															<small class="text-success">
																(배송완료: 상세확인만 가능 / 순서변경 불가)
															</small>
														</div>

														<div class="delivery-list-added-line">
															<strong>주소:</strong>
															<span th:text="${o.roadAddress + ' ' + o.detailAddress}"></span>
														</div>

														<div class="ellipsis delivery-list-added-line">
															<strong>제품 상세:</strong>
															<span th:text="${#strings.isEmpty(o.orderItem.formattedOptionText)
															    ? o.orderItem.productName
															    : o.orderItem.formattedOptionText}">
															</span>
														</div>
													</div>

													<div class="action-btn-group delivery-list-added-action">
														<button type="button" class="action-btn delivery-list-added-open-detail-modal"
															th:attr="data-order-id=${o.id}">
															배송상세
														</button>
													</div>

												</div>
											</div>
										</div>
									</div>

								</div> <!-- card-body -->
							</div>
						</div>
					</div>

				</div>
				<footer th:replace="~{fragments/administration/common :: autoAdminFooter}"></footer>
			</div>
		</div>

		<input type="hidden" id="deliveryHandlerId" th:value="${deliveryHandlerId}">
	</div>

	<!-- =========================================================
		 ✅ 배송완료/배송상세 모달
		 ========================================================= -->
	<div class="modal fade" id="delivery-list-added-modal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-lg delivery-list-added-modal-dialog">
			<div class="modal-content delivery-list-added-modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="delivery-list-added-modal-title">배송상세</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>

				<div class="modal-body">
					<div class="delivery-list-added-modal-skeleton" id="delivery-list-added-modal-skeleton">
						<div class="placeholder-glow">
							<div class="placeholder col-7 mb-2"></div>
							<div class="placeholder col-10 mb-2"></div>
							<div class="placeholder col-12 mb-2"></div>
							<div class="placeholder col-9 mb-2"></div>
						</div>
					</div>

					<div class="delivery-list-added-modal-body" id="delivery-list-added-modal-body" style="display:none;">
						<div class="delivery-list-added-info-grid">
							<div class="delivery-list-added-info-item">
								<div class="delivery-list-added-info-label">업체명</div>
								<div class="delivery-list-added-info-value" id="delivery-list-added-companyName">-</div>
							</div>
							<div class="delivery-list-added-info-item">
								<div class="delivery-list-added-info-label">주문자</div>
								<div class="delivery-list-added-info-value" id="delivery-list-added-requesterName">-</div>
							</div>
							<div class="delivery-list-added-info-item">
								<div class="delivery-list-added-info-label">업체 연락처</div>
								<div class="delivery-list-added-info-value" id="delivery-list-added-companyContact">-</div>
							</div>
							<div class="delivery-list-added-info-item">
								<div class="delivery-list-added-info-label">배송지 주소</div>
								<div class="delivery-list-added-info-value" id="delivery-list-added-orderAddress">-</div>
							</div>
							<div class="delivery-list-added-info-item delivery-list-added-info-item-wide">
								<div class="delivery-list-added-info-label">주문 제품 내용</div>
								<div class="delivery-list-added-info-value delivery-list-added-prewrap" id="delivery-list-added-productText">-</div>
							</div>
						</div>

						<!-- ✅ 기존 배송완료 증빙 이미지 표시 -->
						<div class="delivery-list-added-existing-wrap" id="delivery-list-added-existing-wrap" style="display:none;">
							<hr class="my-3" />
							<div class="delivery-list-added-existing-title">배송 증빙 이미지</div>
							<div class="delivery-list-added-existing-list" id="delivery-list-added-existing-list"></div>
						</div>

						<!-- ✅ 업로드 영역(배송완료 모드에서만 노출) -->
						<div class="delivery-list-added-upload-wrap" id="delivery-list-added-upload-wrap" style="display:none;">
							<hr class="my-3" />
							<div class="delivery-list-added-upload-title">배송 증빙 이미지 첨부</div>

							<div class="delivery-list-added-upload-actions">
								<button type="button" class="btn btn-outline-primary delivery-list-added-btn-camera" id="delivery-list-added-btn-camera">
									바로 사진촬영
								</button>
								<button type="button" class="btn btn-outline-secondary delivery-list-added-btn-gallery" id="delivery-list-added-btn-gallery">
									갤러리에서 불러오기
								</button>
							</div>

							<input type="file" accept="image/*" capture="environment" class="d-none" id="delivery-list-added-file-camera">
							<input type="file" accept="image/*" multiple class="d-none" id="delivery-list-added-file-gallery">

							<div class="delivery-list-added-thumb-list" id="delivery-list-added-thumb-list"></div>
							<div class="text-muted small mt-2">
								※ 이미지 1장 이상 첨부 시 배송완료 버튼이 활성화됩니다.
							</div>
						</div>

					</div>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-light" data-bs-dismiss="modal">닫기</button>

					<button type="button" class="btn btn-success" id="delivery-list-added-btn-submit" disabled style="display:none;">
						배송완료
					</button>
				</div>
			</div>
		</div>
	</div>

	<th:block th:replace="~{fragments/administration/common :: autoAdminSetting}"></th:block>
	<th:block th:replace="~{fragments/administration/common :: authAdminScript}"></th:block>

	<script src="/administration/assets/libs/sortablejs/Sortable.min.js"></script>
	<script src="/administration/assets/libs/prismjs/prism.js"></script>
	<script src="https://cdn.lordicon.com/libs/mssddfmo/lord-icon-2.1.0.js"></script>
	<script src="/administration/assets/js/pages/modal.init.js"></script>

	<link rel="stylesheet" href="/administration/assets/team/delivery/deliveryList.added.css">
	<script src="/administration/assets/team/delivery/deliveryList.added.js"></script>

</body class="twocolumn-panel">
</html>
