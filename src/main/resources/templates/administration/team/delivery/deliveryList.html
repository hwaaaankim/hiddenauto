<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko" data-layout="twocolumn" data-sidebar="light" data-sidebar-size="lg"
	data-sidebar-image="none" data-preloader="disable">

<head th:replace="~{fragments/administration/common :: autoAdminHead}"></head>

<body>
	<div id="layout-wrapper">
		<header th:replace="~{fragments/administration/common :: autoAdminHeader}"></header>
		<div th:replace="~{fragments/administration/common :: autoAdminModal}"></div>
		<div th:replace="~{fragments/administration/common :: autoAdminSideMenu}"></div>
		<div class="vertical-overlay"></div>

		<div class="main-content">
			<div class="page-content">
				<div class="container-fluid">

					<div class="row">
						<div class="col-12">
							<div class="page-title-box d-sm-flex align-items-center justify-content-between">
								<h4 class="mb-sm-0">배송리스트</h4>
								<div class="page-title-right">
									<ol class="breadcrumb m-0">
										<li class="breadcrumb-item"><a href="javascript: void(0);">팀별업무관리</a></li>
										<li class="breadcrumb-item"><a href="javascript: void(0);">배송팀</a></li>
										<li class="breadcrumb-item active">배송리스트</li>
									</ol>
								</div>
							</div>
						</div>
					</div>

					<!-- ✅ 필터 폼 -->
					<form method="get" th:action="@{/team/deliveryList}" class="row">
						<div class="col-lg-10">
							<div class="row g-4 mb-3">

								<div class="col-lg-4">
									<label class="form-label">출고일 조회</label>
									<input type="text" name="preferredDate" id="deliveryDate" class="form-control"
										placeholder="YYYY-MM-DD" data-provider="flatpickr" th:value="${preferredDate}">
								</div>

								<div class="col-lg-4">
									<label class="form-label">상태</label>
									<select class="form-select" name="status">
										<option value="" th:selected="${status == null}">전체(승인/생산완료/배송완료)</option>
										<option th:each="st : ${availableStatuses}" th:value="${st}"
											th:text="${st.label}"
											th:selected="${status != null and status.name() == st.name()}">
										</option>
									</select>
								</div>

								<div class="col-lg-2">
									<label class="form-label">조회</label>
									<button type="submit" class="btn btn-primary w-100">검색하기</button>
								</div>

							</div>
						</div>
					</form>

					<div class="row">
						<div class="col-lg-12">
							<div class="card">
								<div class="card-header d-flex align-items-center justify-content-between">
									<div class="d-flex align-items-center gap-2">
										<button type="button" class="btn btn-success" id="saveOrderIndexBtn" disabled>
											순서 저장
										</button>

										<!-- ✅ 추가: 업체별정렬 버튼 (순서저장 옆) -->
										<button type="button" class="btn btn-outline-primary" id="reorderByTaskBtn">
											업체별정렬
										</button>

										<small class="text-muted">
											※ 미완료(승인/생산완료)만 순서 변경 가능하며, 배송완료는 하단 고정입니다.
										</small>
									</div>

									<div>
										<span class="badge bg-warning-subtle text-warning me-1">미완료</span>
										<span class="badge bg-success-subtle text-success">배송완료</span>
									</div>
								</div>

								<div class="card-body">

									<!-- ✅ 미완료 섹션 -->
									<div class="mb-3">
										<h5 class="mb-2">미완료</h5>

										<div id="pendingList" class="list-group col nested-list nested-sortable">
											<!-- pendingOrders -->
											<div class="list-group-item nested-1 draggable-item delivery-card"
												th:each="wrap : ${pendingOrders}" th:with="o=${wrap.order}" th:attr="
													data-order-id=${o.id},
													data-task-id=${o.task != null ? o.task.id : 0}
												" th:classappend="${o.status.name() == 'PRODUCTION_DONE'} ? ' border border-warning' : ' border border-secondary'">

												<div class="item-content">
													<div class="text-section">
														<div class="d-flex align-items-center gap-2 mb-1">
															<strong>업체명:</strong>
															<span
																th:text="${o.task.requestedBy.company.companyName}"></span>

															<!-- 상태 배지 -->
															<span class="badge" th:classappend="${o.status.name() == 'CONFIRMED'} ? ' bg-secondary' :
																			   (${o.status.name() == 'PRODUCTION_DONE'} ? ' bg-warning' : ' bg-light')"
																th:text="${o.status.label}">
															</span>

															<!-- 안내 메시지 -->
															<small class="text-muted"
																th:if="${o.status.name() == 'CONFIRMED'}">
																(승인 상태: 상태변경 불가)
															</small>
															<small class="text-muted"
																th:if="${o.status.name() == 'PRODUCTION_DONE'}">
																(완료처리 가능)
															</small>
														</div>

														<div>
															<strong>주소:</strong>
															<span
																th:text="${o.roadAddress + ' ' + o.detailAddress}"></span>
														</div>

														<div class="ellipsis">
															<strong>제품 상세:</strong>
															<span th:text="${#strings.isEmpty(o.orderItem.formattedOptionText) 
															    ? o.orderItem.productName 
															    : o.orderItem.formattedOptionText}">
															</span>
														</div>
													</div>

													<div class="action-btn-group">
														<a class="action-btn"
															th:href="@{'/team/deliveryDetail/' + ${o.id}}">
															상세보기
														</a>

														<!-- ✅ 완료처리 버튼은 PRODUCTION_DONE일 때만 -->
														<button type="button" class="action-btn btn-complete"
															th:if="${o.status.name() == 'PRODUCTION_DONE'}"
															th:attr="data-order-id=${o.id}">
															완료처리
														</button>

														<!-- CONFIRMED는 상태변경 불가 -->
														<button type="button" class="action-btn action-btn-disabled"
															disabled th:if="${o.status.name() == 'CONFIRMED'}">
															상태변경불가
														</button>
													</div>
												</div>

											</div>
										</div>
									</div>

									<!-- ✅ 배송완료 섹션 -->
									<div class="mt-4">
										<h5 class="mb-2">배송완료</h5>

										<div id="doneList" class="list-group col nested-list">
											<!-- doneOrders -->
											<div class="list-group-item nested-1 draggable-item delivery-card is-done border border-success"
												th:each="wrap : ${doneOrders}" th:with="o=${wrap.order}" th:attr="
													data-order-id=${o.id},
													data-task-id=${o.task != null ? o.task.id : 0}
												">

												<div class="item-content">
													<div class="text-section">
														<div class="d-flex align-items-center gap-2 mb-1">
															<strong>업체명:</strong>
															<span
																th:text="${o.task.requestedBy.company.companyName}"></span>

															<span class="badge bg-success"
																th:text="${o.status.label}"></span>

															<small class="text-success">
																(배송완료: 순서/상태 변경 불가)
															</small>
														</div>

														<div>
															<strong>주소:</strong>
															<span
																th:text="${o.roadAddress + ' ' + o.detailAddress}"></span>
														</div>

														<div class="ellipsis">
															<strong>제품 상세:</strong>
															<span th:text="${o.orderItem.productName}"></span>
														</div>
													</div>

													<div class="action-btn-group">
														<a class="action-btn"
															th:href="@{'/team/deliveryDetail/' + ${o.id}}">
															상세보기
														</a>
														<button type="button" class="action-btn action-btn-disabled"
															disabled>
															완료됨
														</button>
													</div>
												</div>

											</div>
										</div>
									</div>

								</div> <!-- card-body -->
							</div>
						</div>
					</div>

				</div>
				<footer th:replace="~{fragments/administration/common :: autoAdminFooter}"></footer>
			</div>
		</div>

		<input type="hidden" id="deliveryHandlerId" th:value="${deliveryHandlerId}">
	</div>

	<th:block th:replace="~{fragments/administration/common :: autoAdminSetting}"></th:block>
	<th:block th:replace="~{fragments/administration/common :: authAdminScript}"></th:block>

	<script src="/administration/assets/libs/sortablejs/Sortable.min.js"></script>
	<script src="/administration/assets/libs/prismjs/prism.js"></script>
	<script src="https://cdn.lordicon.com/libs/mssddfmo/lord-icon-2.1.0.js"></script>
	<script src="/administration/assets/js/pages/modal.init.js"></script>

	<style>
		/* hover 시 버튼 노출 유지(현재 구조 그대로) + 비활성 버튼 스타일 */
		.action-btn-disabled {
			opacity: 0.6;
			cursor: not-allowed;
		}

		.delivery-card.is-done {
			background: rgba(25, 135, 84, 0.04);
		}

		/* =========================================================
		   ✅ 동일 Task 그룹 구분 스타일 (요구: 접두사 delivery-list-added-)
		   - 카드 왼쪽 라인 + 약한 배경으로 그룹 구분
		   - alt-0 / alt-1 두 가지로 번갈아 표시
		   ========================================================= */
		.delivery-list-added-task-group-alt-0 {
			border-left: 6px solid rgba(13, 110, 253, 0.55) !important;
			/* primary 느낌 */
			background: rgba(13, 110, 253, 0.03);
		}

		.delivery-list-added-task-group-alt-1 {
			border-left: 6px solid rgba(102, 16, 242, 0.45) !important;
			/* 보라 느낌 */
			background: rgba(102, 16, 242, 0.025);
		}

		/* 그룹 경계(바뀌는 지점) 시각적 구분 */
		.delivery-list-added-task-group-break {
			box-shadow: 0 -6px 0 rgba(0, 0, 0, 0.03) inset;
		}
	</style>

	<script>
		(function () {
			'use strict';

			const saveButton = document.getElementById("saveOrderIndexBtn");
			const reorderByTaskBtn = document.getElementById("reorderByTaskBtn");

			const pendingListEl = document.getElementById("pendingList");
			const doneListEl = document.getElementById("doneList");

			// CSRF
			const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
			const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

			function getDeliveryHandlerId() {
				return document.getElementById("deliveryHandlerId")?.value || "";
			}

			function getDeliveryDate() {
				return document.getElementById("deliveryDate")?.value || "";
			}

			function getPendingOrderIdsInDomOrder() {
				return Array.from(pendingListEl.querySelectorAll(".draggable-item"))
					.map(el => Number(el.getAttribute("data-order-id")))
					.filter(n => Number.isFinite(n) && n > 0);
			}

			function applyTaskGroupStyles(listEl) {
				const items = Array.from(listEl.querySelectorAll(".draggable-item"));
				let lastTaskId = null;
				let alt = 0;

				for (const el of items) {
					el.classList.remove("delivery-list-added-task-group-alt-0");
					el.classList.remove("delivery-list-added-task-group-alt-1");
					el.classList.remove("delivery-list-added-task-group-break");

					const taskId = el.getAttribute("data-task-id") || "0";
					if (lastTaskId === null) {
						// 첫 항목
					} else if (taskId !== lastTaskId) {
						// 그룹이 바뀌는 지점: alt 토글 + 경계 표시
						alt = (alt === 0 ? 1 : 0);
						el.classList.add("delivery-list-added-task-group-break");
					}
					el.classList.add(alt === 0 ? "delivery-list-added-task-group-alt-0" : "delivery-list-added-task-group-alt-1");
					lastTaskId = taskId;
				}
			}

			function applyAllTaskGroupStyles() {
				applyTaskGroupStyles(pendingListEl);
				applyTaskGroupStyles(doneListEl);
			}

			// ✅ 초기 로드 로그(디버그) + 그룹 스타일 적용
			document.addEventListener("DOMContentLoaded", function () {
				const deliveryDate = getDeliveryDate() || "(날짜 미지정)";
				const pendingIds = Array.from(pendingListEl.querySelectorAll(".draggable-item")).map(x => x.getAttribute("data-order-id"));
				const doneIds = Array.from(doneListEl.querySelectorAll(".draggable-item")).map(x => x.getAttribute("data-order-id"));
				console.log("=== [초기 로드] ===");
				console.log(`[${deliveryDate}] pendingIds=`, pendingIds);
				console.log(`[${deliveryDate}] doneIds=`, doneIds);

				applyAllTaskGroupStyles();
			});

			// ✅ Sortable은 "미완료 섹션"에만 적용
			const sortable = new Sortable(pendingListEl, {
				group: "pending",
				animation: 150,
				fallbackOnBody: true,
				swapThreshold: 0.65,
				onEnd: () => {
					saveButton.disabled = false;
					applyAllTaskGroupStyles();
				}
			});

			// ✅ "완료처리" 버튼 동작: confirm -> POST /team/deliveryStatus/{orderId}?status=DELIVERY_DONE -> reload
			document.addEventListener("click", async (e) => {
				const btn = e.target.closest(".btn-complete");
				if (!btn) return;

				const orderId = btn.getAttribute("data-order-id");
				if (!orderId) return;

				const ok = confirm("완료 처리 하시겠습니까?");
				if (!ok) return;

				try {
					const url = `/team/deliveryStatus/${orderId}?status=DELIVERY_DONE`;

					const headers = {};
					if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;

					const res = await fetch(url, {
						method: "POST",
						headers
					});

					if (!res.ok) {
						const text = await res.text().catch(() => "");
						alert("완료처리 실패\n" + (text || ("HTTP " + res.status)));
						return;
					}

					location.reload();
				} catch (err) {
					console.error(err);
					alert("완료처리 중 오류가 발생했습니다.");
				}
			});

			// ✅ 추가: 업체별정렬 버튼 동작
			// - 현재 pending DOM 순서 기준으로 orderIds 전송
			// - 서버가 task 기준으로 stable grouping 후 reorder된 orderIds 반환
			// - 프론트에서 DOM 재배치
			reorderByTaskBtn.addEventListener("click", async () => {
				const deliveryHandlerId = getDeliveryHandlerId();
				const deliveryDate = getDeliveryDate();

				if (!deliveryHandlerId) {
					alert("담당자 정보가 없습니다.");
					return;
				}
				if (!deliveryDate) {
					alert("날짜를 선택해주세요.");
					return;
				}

				const pendingOrderIds = getPendingOrderIdsInDomOrder();
				if (pendingOrderIds.length <= 1) {
					alert("정렬할 항목이 없습니다.");
					return;
				}

				const headers = {"Content-Type": "application/json"};
				if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;

				try {
					const res = await fetch("/team/reorderByTask", {
						method: "POST",
						headers,
						body: JSON.stringify({
							deliveryHandlerId: Number(deliveryHandlerId),
							deliveryDate: deliveryDate,
							pendingOrderIds: pendingOrderIds
						})
					});

					if (!res.ok) {
						const text = await res.text().catch(() => "");
						alert("업체별정렬 실패\n" + (text || ("HTTP " + res.status)));
						return;
					}

					const data = await res.json();
					const reordered = Array.isArray(data?.pendingOrderIds) ? data.pendingOrderIds : [];

					if (reordered.length !== pendingOrderIds.length) {
						alert("업체별정렬 결과가 올바르지 않습니다.(개수 불일치)");
						return;
					}

					// DOM 재배치
					const elById = new Map();
					Array.from(pendingListEl.querySelectorAll(".draggable-item")).forEach(el => {
						const id = Number(el.getAttribute("data-order-id"));
						if (Number.isFinite(id)) elById.set(id, el);
					});

					for (const id of reordered) {
						const el = elById.get(Number(id));
						if (el) pendingListEl.appendChild(el);
					}

					saveButton.disabled = false;
					applyAllTaskGroupStyles();
				} catch (err) {
					console.error(err);
					alert("업체별정렬 중 오류가 발생했습니다.");
				}
			});

			// ✅ 저장: pending + done 합쳐서 DOM 순서대로 1..N 전체 인덱스 재부여(충돌 방지)
			saveButton.addEventListener("click", async () => {
				
				const ok = confirm("업체별(동일배송지별)로 재배치 됩니다. 진행하시겠습니까? 진행하시려면 '순서저장' 버튼을 클릭 해 주세요.");
      			if (!ok) return;
				const deliveryHandlerId = getDeliveryHandlerId();
				const deliveryDate = getDeliveryDate();

				if (!deliveryHandlerId) {
					alert("담당자 정보가 없습니다.");
					return;
				}
				if (!deliveryDate) {
					alert("날짜를 선택해주세요.");
					return;
				}

				const pendingItems = Array.from(pendingListEl.querySelectorAll(".draggable-item"));
				const doneItems = Array.from(doneListEl.querySelectorAll(".draggable-item"));

				// ✅ 최종 노출 순서 = pending(드래그/업체별정렬 반영된 순서) + done(고정)
				const allItems = pendingItems.concat(doneItems);

				const orderedIds = allItems.map((el, idx) => ({
					orderId: Number(el.getAttribute("data-order-id")),
					orderIndex: idx + 1
				}));

				console.log("=== [순서 저장 payload] ===");
				console.log({deliveryHandlerId, deliveryDate, orderList: orderedIds});

				try {
					const headers = {"Content-Type": "application/json"};
					if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;

					const res = await fetch("/team/updateOrderIndex", {
						method: "POST",
						headers,
						body: JSON.stringify({
							deliveryHandlerId: Number(deliveryHandlerId),
							deliveryDate: deliveryDate,
							orderList: orderedIds
						})
					});

					if (res.ok) {
						alert("순서가 저장되었습니다.");
						saveButton.disabled = true;
					} else {
						const text = await res.text().catch(() => "");
						alert("순서 저장 실패\n" + (text || ("HTTP " + res.status)));
					}
				} catch (err) {
					console.error(err);
					alert("순서 저장 중 오류가 발생했습니다.");
				}
			});
		})();
	</script>
</body>

</html>