<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko" data-layout="twocolumn" data-sidebar="light"
	data-sidebar-size="lg" data-sidebar-image="none" data-preloader="disable">

<head th:replace="~{fragments/administration/common :: autoAdminHead}">
</head>

<body class="twocolumn-panel">

	<!-- Begin page -->
	<div id="layout-wrapper">

		<header th:replace="~{fragments/administration/common :: autoAdminHeader}"></header>

		<div th:replace="~{fragments/administration/common :: autoAdminModal}"></div>
		<div th:replace="~{fragments/administration/common :: autoAdminSideMenu}"></div>
		<div class="vertical-overlay"></div>

		<div class="main-content">
			<div class="page-content">
				<div class="container-fluid">

					<!-- start page title -->
					<div class="row">
						<div class="col-12">
							<div class="page-title-box d-sm-flex align-items-center justify-content-between">
								<h4 class="mb-sm-0">AS관리</h4>

								<div class="page-title-right">
									<ol class="breadcrumb m-0">
										<li class="breadcrumb-item"><a href="javascript: void(0);">AS관리</a></li>
										<li class="breadcrumb-item active">AS리스트</li>
									</ol>
								</div>

							</div>
						</div>
					</div>
					<!-- end page title -->

					<div class="row">
						<div class="col-lg-12">
							<div class="card" id="tasksList">

								<div class="card-header border-0">
									<div class="d-flex align-items-center">
										<h5 class="card-title mb-0 flex-grow-1">AS MANAGER</h5>
										<div class="flex-shrink-0">
											<div class="d-flex flex-wrap gap-2">

												<!-- ✅ 엑셀 다운로드: 필터 + 정렬 반영 -->
												<a th:href="@{/management/asList/excel(
													handlerId=${selectedHandlerId},
													status=${selectedStatus},
													dateType=${selectedDateType},
													fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
													toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
													sortField=${sortField},
													sortDir=${sortDir}
												)}" class="btn btn-success">
													<i class="fa-solid fa-download"></i> 엑셀 다운로드
												</a>

											</div>
										</div>
									</div>
								</div>

								<!-- ✅ 정렬/사이즈 포함 검색폼 -->
								<div class="card-body border border-dashed border-end-0 border-start-0">
									<form method="get" action="/management/asList" id="as-list-new-added-filter-form">
										<div class="row g-3">

											<!-- 상태 -->
											<div class="col-md-2">
												<label class="form-label">AS 상태</label>
												<select class="form-select" name="status">
													<option value="">전체</option>
													<option th:each="st : ${T(com.dev.HiddenBATHAuto.model.task.AsStatus).values()}"
														th:value="${st}" th:text="${st}"
														th:selected="${selectedStatus != null and selectedStatus.name() == st.name()}">
													</option>
												</select>
											</div>

											<!-- 담당자 -->
											<div class="col-md-2">
												<label class="form-label">AS 담당자</label>
												<select class="form-select" name="handlerId">
													<option value="" th:selected="${selectedHandlerId == null}">전체</option>
													<option th:each="handler : ${asHandlers}"
														th:value="${handler.id}"
														th:text="${handler.name}"
														th:selected="${selectedHandlerId != null and selectedHandlerId == handler.id}">
													</option>
												</select>
											</div>

											<!-- 날짜 기준 타입 선택 -->
											<div class="col-md-2">
												<label class="form-label">날짜 기준</label>
												<select class="form-select" name="dateType">
													<option value="requested"
														th:selected="${selectedDateType == 'requested'}">신청일 기준</option>
													<option value="processed"
														th:selected="${selectedDateType == 'processed'}">처리일 기준</option>
												</select>
											</div>

											<!-- 시작 날짜 -->
											<div class="col-md-2">
												<label class="form-label">시작일</label>
												<input type="date" class="form-control" name="fromDate"
													th:value="${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''}">
											</div>

											<!-- 종료 날짜 -->
											<div class="col-md-2">
												<label class="form-label">종료일</label>
												<input type="date" class="form-control" name="toDate"
													th:value="${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''}">
											</div>

											<!-- ✅ 페이지 사이즈 -->
											<div class="col-md-1">
												<label class="form-label">페이지 사이즈</label>
												<select class="form-select" name="size" id="as-list-new-added-size-select"
													onchange="document.getElementById('as-list-new-added-filter-form').submit();">
													<option value="10" th:selected="${pageSize == 10}">10개씩</option>
													<option value="30" th:selected="${pageSize == 30}">30개씩</option>
													<option value="50" th:selected="${pageSize == 50}">50개씩</option>
													<option value="100" th:selected="${pageSize == 100}">100개씩</option>
												</select>
											</div>

											<!-- ✅ 정렬 유지용 hidden (검색 누르면 현재 정렬 유지) -->
											<input type="hidden" name="sortField" th:value="${sortField}">
											<input type="hidden" name="sortDir" th:value="${sortDir}">
											<input type="hidden" name="page" value="0">

											<!-- 검색 버튼 -->
											<div class="col-1">
												<label class="form-label">검색</label>
												<button type="submit" class="btn btn-primary w-100">
													<i class="fa-solid fa-magnifying-glass"></i> 검색
												</button>
											</div>

										</div>
									</form>
								</div>


								<div class="card-body">
									<div class="table-responsive table-card mb-4">
										<table class="table align-middle table-nowrap mb-0" id="tasksTable">
											<thead class="table-light text-muted">
												<tr>
													<!-- ✅ 체크박스 열 삭제 -->
													<th>ID</th>

													<!-- ✅ 대리점명 정렬 -->
													<th>
														<div class="as-list-new-added-th-sort">
															<span class="as-list-new-added-sort-label">대리점명</span>
															<span class="as-list-new-added-sort-icons">
																<a class="as-list-new-added-sort-link"
																	th:classappend="${sortField == 'companyName' and sortDir == 'asc'} ? ' as-list-new-added-active' : ''"
																	th:href="@{/management/asList(
																		page=0,
																		size=${pageSize},
																		handlerId=${selectedHandlerId},
																		status=${selectedStatus},
																		dateType=${selectedDateType},
																		fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
																		toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
																		sortField='companyName',
																		sortDir='asc'
																	)}" aria-label="대리점명 오름차순">
																	<i class="fa-solid fa-caret-up"></i>
																</a>
																<a class="as-list-new-added-sort-link"
																	th:classappend="${sortField == 'companyName' and sortDir == 'desc'} ? ' as-list-new-added-active' : ''"
																	th:href="@{/management/asList(
																		page=0,
																		size=${pageSize},
																		handlerId=${selectedHandlerId},
																		status=${selectedStatus},
																		dateType=${selectedDateType},
																		fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
																		toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
																		sortField='companyName',
																		sortDir='desc'
																	)}" aria-label="대리점명 내림차순">
																	<i class="fa-solid fa-caret-down"></i>
																</a>
															</span>
														</div>
													</th>

													<!-- ✅ 신청자 정렬 -->
													<th>
														<div class="as-list-new-added-th-sort">
															<span class="as-list-new-added-sort-label">신청자</span>
															<span class="as-list-new-added-sort-icons">
																<a class="as-list-new-added-sort-link"
																	th:classappend="${sortField == 'requesterName' and sortDir == 'asc'} ? ' as-list-new-added-active' : ''"
																	th:href="@{/management/asList(
																		page=0,size=${pageSize},
																		handlerId=${selectedHandlerId},status=${selectedStatus},dateType=${selectedDateType},
																		fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
																		toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
																		sortField='requesterName',sortDir='asc'
																	)}">
																	<i class="fa-solid fa-caret-up"></i>
																</a>
																<a class="as-list-new-added-sort-link"
																	th:classappend="${sortField == 'requesterName' and sortDir == 'desc'} ? ' as-list-new-added-active' : ''"
																	th:href="@{/management/asList(
																		page=0,size=${pageSize},
																		handlerId=${selectedHandlerId},status=${selectedStatus},dateType=${selectedDateType},
																		fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
																		toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
																		sortField='requesterName',sortDir='desc'
																	)}">
																	<i class="fa-solid fa-caret-down"></i>
																</a>
															</span>
														</div>
													</th>

													<!-- ✅ 담당 사원 정렬 -->
													<th>
													  <div class="as-list-new-added-th-sort">
													    <span class="as-list-new-added-sort-label">담당AS사원</span>
													    <span class="as-list-new-added-sort-icons">
													
													      <!-- ASC -->
													      <a class="as-list-new-added-sort-link"
													         th:classappend="${sortField == 'handlerName' and sortDir == 'asc'} ? ' as-list-new-added-active' : ''"
													         th:href="@{/management/asList(
													           page=0,
													           size=${pageSize},
													           handlerId=${selectedHandlerId},
													           status=${selectedStatus},
													           dateType=${selectedDateType},
													           fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
													           toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
													           sortField=${'handlerName'},
													           sortDir=${'asc'}
													         )}"
													         aria-label="담당AS사원 오름차순">
													        <i class="fa-solid fa-caret-up"></i>
													      </a>
													
													      <!-- DESC -->
													      <a class="as-list-new-added-sort-link"
													         th:classappend="${sortField == 'handlerName' and sortDir == 'desc'} ? ' as-list-new-added-active' : ''"
													         th:href="@{/management/asList(
													           page=0,
													           size=${pageSize},
													           handlerId=${selectedHandlerId},
													           status=${selectedStatus},
													           dateType=${selectedDateType},
													           fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
													           toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
													           sortField=${'handlerName'},
													           sortDir=${'desc'}
													         )}"
													         aria-label="담당AS사원 내림차순">
													        <i class="fa-solid fa-caret-down"></i>
													      </a>
													
													    </span>
													  </div>
													</th>


													<!-- ✅ 신청일 정렬 -->
													<th>
														<div class="as-list-new-added-th-sort">
															<span class="as-list-new-added-sort-label">신청일</span>
															<span class="as-list-new-added-sort-icons">
																<a class="as-list-new-added-sort-link"
																	th:classappend="${sortField == 'requestedAt' and sortDir == 'asc'} ? ' as-list-new-added-active' : ''"
																	th:href="@{/management/asList(
																		page=0,size=${pageSize},
																		handlerId=${selectedHandlerId},status=${selectedStatus},dateType=${selectedDateType},
																		fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
																		toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
																		sortField='requestedAt',sortDir='asc'
																	)}">
																	<i class="fa-solid fa-caret-up"></i>
																</a>
																<a class="as-list-new-added-sort-link"
																	th:classappend="${sortField == 'requestedAt' and sortDir == 'desc'} ? ' as-list-new-added-active' : ''"
																	th:href="@{/management/asList(
																		page=0,size=${pageSize},
																		handlerId=${selectedHandlerId},status=${selectedStatus},dateType=${selectedDateType},
																		fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
																		toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
																		sortField='requestedAt',sortDir='desc'
																	)}">
																	<i class="fa-solid fa-caret-down"></i>
																</a>
															</span>
														</div>
													</th>

													<th>최근수정일</th>

													<!-- ✅ 처리일 정렬 -->
													<th>
														<div class="as-list-new-added-th-sort">
															<span class="as-list-new-added-sort-label">처리일</span>
															<span class="as-list-new-added-sort-icons">
																<a class="as-list-new-added-sort-link"
																	th:classappend="${sortField == 'asProcessDate' and sortDir == 'asc'} ? ' as-list-new-added-active' : ''"
																	th:href="@{/management/asList(
																		page=0,size=${pageSize},
																		handlerId=${selectedHandlerId},status=${selectedStatus},dateType=${selectedDateType},
																		fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
																		toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
																		sortField='asProcessDate',sortDir='asc'
																	)}">
																	<i class="fa-solid fa-caret-up"></i>
																</a>
																<a class="as-list-new-added-sort-link"
																	th:classappend="${sortField == 'asProcessDate' and sortDir == 'desc'} ? ' as-list-new-added-active' : ''"
																	th:href="@{/management/asList(
																		page=0,size=${pageSize},
																		handlerId=${selectedHandlerId},status=${selectedStatus},dateType=${selectedDateType},
																		fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
																		toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
																		sortField='asProcessDate',sortDir='desc'
																	)}">
																	<i class="fa-solid fa-caret-down"></i>
																</a>
															</span>
														</div>
													</th>

													<!-- ✅ 상태 정렬 -->
													<th>
														<div class="as-list-new-added-th-sort">
															<span class="as-list-new-added-sort-label">상태</span>
															<span class="as-list-new-added-sort-icons">
																<a class="as-list-new-added-sort-link"
																	th:classappend="${sortField == 'status' and sortDir == 'asc'} ? ' as-list-new-added-active' : ''"
																	th:href="@{/management/asList(
																		page=0,size=${pageSize},
																		handlerId=${selectedHandlerId},status=${selectedStatus},dateType=${selectedDateType},
																		fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
																		toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
																		sortField='status',sortDir='asc'
																	)}">
																	<i class="fa-solid fa-caret-up"></i>
																</a>
																<a class="as-list-new-added-sort-link"
																	th:classappend="${sortField == 'status' and sortDir == 'desc'} ? ' as-list-new-added-active' : ''"
																	th:href="@{/management/asList(
																		page=0,size=${pageSize},
																		handlerId=${selectedHandlerId},status=${selectedStatus},dateType=${selectedDateType},
																		fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
																		toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
																		sortField='status',sortDir='desc'
																	)}">
																	<i class="fa-solid fa-caret-down"></i>
																</a>
															</span>
														</div>
													</th>

												</tr>
											</thead>

											<tbody class="list form-check-all">
												<tr th:each="as : ${asPage.content}">

													<td>
														<a th:href="@{/management/asDetail/{id}(id=${as.id})}"
															class="fw-medium link-primary"
															th:text="${'AS_TASK_#' + as.id}">AS_TASK_0</a>
													</td>

													<td class="project_name">
														<a href="#" class="fw-medium link-primary"
															th:text="${as.requestedBy != null and as.requestedBy.company != null ? as.requestedBy.company.companyName : '미지정'}">
															대리점명</a>
													</td>

													<td>
														<a href="#" th:text="${as.requestedBy != null ? as.requestedBy.name : '미지정'}">신청자명</a>
													</td>

													<td class="assignedto">
														<span th:if="${as.assignedHandler != null}" th:text="${as.assignedHandler.name}">사원이름</span>
														<span class="text-muted" th:if="${as.assignedHandler == null}">미지정</span>
													</td>

													<td th:text="${as.requestedAt != null ? #temporals.format(as.requestedAt, 'yyyy-MM-dd HH:mm') : '-'}">00:00</td>
													<td th:text="${as.updatedAt != null ? #temporals.format(as.updatedAt, 'yyyy-MM-dd HH:mm') : '-'}">00:00</td>
													<td th:text="${as.asProcessDate != null ? #temporals.format(as.asProcessDate, 'yyyy-MM-dd HH:mm') : '-'}">00:00</td>

													<td class="status">
														<span class="badge text-uppercase"
															th:classappend="|bg-${
																as.status != null and as.status.name() == 'REQUESTED' ? 'secondary-subtle text-secondary' :
																as.status != null and as.status.name() == 'IN_PROGRESS' ? 'warning-subtle text-warning' :
																as.status != null and as.status.name() == 'COMPLETED' ? 'success-subtle text-success' : 'light'
															}|"
															th:text="${as.status != null ? as.status.name() : 'UNKNOWN'}">상태</span>
													</td>
												</tr>
											</tbody>

										</table>

										<div class="noresult" th:if="${asPage.totalElements == 0}">
											<div class="text-center">
												<lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop"
													colors="primary:#121331,secondary:#08a88a" style="width:75px;height:75px"></lord-icon>
												<h5 class="mt-2">결과가 존재하지않습니다.</h5>
												<p class="text-muted mb-0">다른 조건으로 검색을 진행 해 주시기 바랍니다.</p>
											</div>
										</div>

									</div>

									<!-- ✅ 페이지네이션: 필터 + 정렬 + size 반영 -->
									<div class="d-flex justify-content-end mt-2">
										<div class="pagination-wrap hstack gap-2">
											<nav aria-label="navigation" style="text-align: center;">
												<ul class="pagination justify-content-center">

													<li class="page-item" th:classappend="${asPage.first} ? 'disabled'">
														<a class="page-link"
															th:href="@{/management/asList(
																page=0,
																size=${pageSize},
																handlerId=${selectedHandlerId},
																status=${selectedStatus},
																dateType=${selectedDateType},
																fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
																toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
																sortField=${sortField},
																sortDir=${sortDir}
															)}">First</a>
													</li>

													<li class="page-item" th:classappend="${asPage.first} ? 'disabled'">
														<a class="page-link"
															th:href="@{/management/asList(
																page=${asPage.number - 1},
																size=${pageSize},
																handlerId=${selectedHandlerId},
																status=${selectedStatus},
																dateType=${selectedDateType},
																fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
																toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
																sortField=${sortField},
																sortDir=${sortDir}
															)}">Previous</a>
													</li>

													<li class="page-item"
														th:each="pageNum : ${#numbers.sequence(0, asPage.totalPages - 1)}"
														th:classappend="${asPage.number == pageNum} ? 'active'">
														<a class="page-link"
															th:href="@{/management/asList(
																page=${pageNum},
																size=${pageSize},
																handlerId=${selectedHandlerId},
																status=${selectedStatus},
																dateType=${selectedDateType},
																fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
																toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
																sortField=${sortField},
																sortDir=${sortDir}
															)}"
															th:text="${pageNum + 1}">1</a>
													</li>

													<li class="page-item" th:classappend="${asPage.last} ? 'disabled'">
														<a class="page-link"
															th:href="@{/management/asList(
																page=${asPage.number + 1},
																size=${pageSize},
																handlerId=${selectedHandlerId},
																status=${selectedStatus},
																dateType=${selectedDateType},
																fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
																toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
																sortField=${sortField},
																sortDir=${sortDir}
															)}">Next</a>
													</li>

													<li class="page-item" th:classappend="${asPage.last} ? 'disabled'">
														<a class="page-link"
															th:href="@{/management/asList(
																page=${asPage.totalPages - 1},
																size=${pageSize},
																handlerId=${selectedHandlerId},
																status=${selectedStatus},
																dateType=${selectedDateType},
																fromDate=${selectedFromDate != null ? #temporals.format(selectedFromDate, 'yyyy-MM-dd') : ''},
																toDate=${selectedToDate != null ? #temporals.format(selectedToDate, 'yyyy-MM-dd') : ''},
																sortField=${sortField},
																sortDir=${sortDir}
															)}">Last</a>
													</li>

												</ul>
											</nav>
										</div>
									</div>

								</div>

							</div>
						</div>
					</div>

				</div>
			</div>

			<footer th:replace="~{fragments/administration/common :: autoAdminFooter}"></footer>
		</div>
	</div>

	<th:block th:replace="~{fragments/administration/common :: autoAdminSetting}"></th:block>
	<th:block th:replace="~{fragments/administration/common :: authAdminScript}"></th:block>

</body>
</html>
